---
import { render, type CollectionEntry } from 'astro:content'

import { MediumZoom } from 'astro-pure/advanced'
import { TOC } from 'astro-pure/components/pages'
import { getBlogCollection, sortMDByDate } from 'astro-pure/server'
import { Button } from 'astro-pure/user'
import PageLayout from '@/layouts/ContentLayout.astro'

import NotesContents from './NotesContents.astro'

export const prerender = true

export async function getStaticPaths() {
  const posts = sortMDByDate(await getBlogCollection('notes'))
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post }
  }))
}

type Props = {
  post: CollectionEntry<'notes'>
}

const { post } = Astro.props
const { Content, headings } = await render(post)
const { description, title } = post.data

const editPath = `https://github.com/Nakanomk/Nknsblog_astro_rebuild/edit/main/${post.filePath}`
---

<PageLayout meta={{ description, title }} back='/notes'>
  <Fragment slot='sidebar'>
    <div class='sidebar-header'>
      <h2 id='sidebar-title' class='text-foreground font-semibold'>TOC</h2>
      <button id='sidebar-toggle-btn' class='text-sm text-muted-foreground hover:text-foreground transition-colors'>NOTES</button>
    </div>

    <div id='toc-container' class='mt-4'>
      {!!headings.length && <TOC {headings} />}
    </div>

    <div id='notes-container' class='sidebar-view-hidden mt-3'>
      <NotesContents class='notes-toc block' />
    </div>

    <script is:inline>
      function setupSidebarToggle() {
        const titleEl = document.getElementById('sidebar-title')
        const toggleBtn = document.getElementById('sidebar-toggle-btn')
        const tocContainer = document.getElementById('toc-container')
        const notesContainer = document.getElementById('notes-container')

        if (!titleEl || !toggleBtn || !tocContainer || !notesContainer) {
          return
        }

        let isTocVisible = true

        if (tocContainer.innerHTML.trim() === '') {
          isTocVisible = false
        }

        function updateView() {
          if (isTocVisible) {
            titleEl.textContent = 'TOC'
            toggleBtn.textContent = 'NOTES'
            tocContainer.style.display = 'block'
            tocContainer.classList.add('animate-fade-in-up')
            notesContainer.classList.add('sidebar-view-hidden')
            toggleBtn.style.display = 'block'
          } else {
            titleEl.textContent = 'NOTES'
            toggleBtn.textContent = 'TOC'
            tocContainer.style.display = 'none'
            notesContainer.classList.remove('sidebar-view-hidden')
            notesContainer.classList.add('animate-fade-in-up')
          }

          if (tocContainer.innerHTML.trim() === '') {
            toggleBtn.style.display = 'none'
          }
        }

        toggleBtn.addEventListener('click', () => {
          isTocVisible = !isTocVisible
          updateView()
        })

        updateView()
      }

      // Astro's view transitions will re-run this script.
      // We can just call the setup function directly.
      // If not using view transitions, we'd use DOMContentLoaded.
      setupSidebarToggle()
      document.addEventListener('astro:after-swap', setupSidebarToggle)
    </script>

    <style>
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.3s ease-out;
      }

      .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #sidebar-toggle-btn {
        background: none;
        border: 1px solid hsl(var(--border));
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius);
        min-width: 60px; /* Keep button size constant */
        text-align: center;
        cursor: pointer;
        margin-right: 0.5rem; /* Move button slightly from the edge */
      }
      .sidebar-view-hidden {
        display: none;
      }
    </style>
  </Fragment>

  <Fragment slot='header'>
    <h1 class='text-2xl font-medium sm:mb-2 sm:text-3xl'>
      {title}
    </h1>
    <div class='mt-4 flex flex-wrap gap-x-4 gap-y-2 text-xs leading-6 text-muted-foreground'>
      {
        // Description
        description && (
          <blockquote class='text-sm italic text-muted-foreground'>
            <q>{description}</q>
          </blockquote>
        )
      }
    </div>
    {

        /* Show more notes collapse on small screen */
        // <Collapse class='md:hidden' title='See more notes'>
        //   <NotesContents title={false} />
        // </Collapse>
    }
  </Fragment>

  <Content />

  <div slot='bottom'>
    <Button title='Edit on GitHub' href={editPath} class='px-3 py-2' style='font-size:1rem'>
      {/* mingcute:edit-2-line */}
      <!-- prettier-ignore -->
      <svg slot='before' xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'><!-- Icon from MingCute Icon by MingCute Design - https://github.com/Richard9394/MingCute/blob/main/LICENSE --><g fill='none' fill-rule='evenodd'><path d='m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z'/><path fill='currentColor' d='M13.896 3.03a2 2 0 0 1 2.701-.117l.127.117l4.243 4.243a2 2 0 0 1 .117 2.7l-.117.128l-10.314 10.314a2 2 0 0 1-1.238.578L9.239 21H4.006a1.01 1.01 0 0 1-1.004-.9l-.006-.11v-5.233a2 2 0 0 1 .467-1.284l.12-.13L13.895 3.03ZM12.17 7.584l-7.174 7.174V19H9.24l7.174-7.174l-4.243-4.243Zm3.14-3.14L13.584 6.17l4.243 4.243l1.726-1.726z'/></g></svg>
      Edit on GitHub
    </Button>
    {/* Show notes contents */}
    <div class='rounded-xl border px-4 py-3 mt-3 sm:py-4 md:mt-6'>
      <NotesContents />
    </div>
  </div>
</PageLayout>
<MediumZoom />
